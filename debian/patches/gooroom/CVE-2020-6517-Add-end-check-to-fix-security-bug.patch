From 005cf7af1a31180334c462531abf7fcc43f56a9c Mon Sep 17 00:00:00 2001
From: Becca Hughes <beccahughes@chromium.org>
Date: Mon, 20 Jul 2020 18:54:59 +0000
Subject: [PATCH] Add end() check to fix security bug

Fix the bug by checking we have not reached the
end before accessing.

BUG=1095560

(cherry picked from commit 1755fa3ec13735194ebc95b9c06052244040fdae)

Change-Id: I309237562ddd5058c3b3b99d58a03c526cf49b6a
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2276511
Commit-Queue: Becca Hughes <beccahughes@chromium.org>
Reviewed-by: Robert Sesek <rsesek@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#784113}
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2307618
Reviewed-by: Becca Hughes <beccahughes@chromium.org>
Cr-Commit-Position: refs/branch-heads/4183@{#758}
Cr-Branched-From: 740e9e8a40505392ba5c8e022a8024b3d018ca65-refs/heads/master@{#782793}
---
 .../media/history/media_history_keyed_service.cc     |  4 +++-
 .../history/media_history_keyed_service_unittest.cc  | 12 ++++++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/chrome/browser/media/history/media_history_keyed_service.cc b/chrome/browser/media/history/media_history_keyed_service.cc
index 6caa266ac..f7597638c 100644
--- a/chrome/browser/media/history/media_history_keyed_service.cc
+++ b/chrome/browser/media/history/media_history_keyed_service.cc
@@ -132,8 +132,10 @@ void MediaHistoryKeyedService::OnURLsDeleted(
     const auto& origin_count =
         deletion_info.deleted_urls_origin_map().find(origin.GetURL());
 
-    if (origin_count->second.first > 0)
+    if (origin_count == deletion_info.deleted_urls_origin_map().end() ||
+        origin_count->second.first > 0) {
       continue;
+    }
 
     deleted_origins.insert(origin);
   }
diff --git a/chrome/browser/media/history/media_history_keyed_service_unittest.cc b/chrome/browser/media/history/media_history_keyed_service_unittest.cc
index cb185e60b..42ddc68df 100644
--- a/chrome/browser/media/history/media_history_keyed_service_unittest.cc
+++ b/chrome/browser/media/history/media_history_keyed_service_unittest.cc
@@ -692,4 +692,16 @@ TEST_P(MediaHistoryKeyedServiceTest, CleanUpDatabaseWhenURLIsDeleted) {
   EXPECT_EQ(media_feeds, GetURLsInTable(MediaHistoryFeedsTable::kTableName));
 }
 
+TEST_P(MediaHistoryKeyedServiceTest, SecurityRegressionTest) {
+  history::URLRows urls_to_delete = {
+      history::URLRow(GURL("https://www.google.com/test1A"))};
+  history::DeletionInfo deletion_info =
+      history::DeletionInfo::ForUrls(urls_to_delete, std::set<GURL>());
+  deletion_info.set_deleted_urls_origin_map({
+      {GURL("https://www.google.com/test1B"), {0, base::Time::Now()}},
+      {GURL("https://www.google.com/test1C"), {0, base::Time::Now()}},
+  });
+
+  service()->OnURLsDeleted(nullptr, deletion_info);
+}
 }  // namespace media_history
-- 
2.20.1

