From fb5c2cffe7014bc3b5c287d2daae603ef2c8e52c Mon Sep 17 00:00:00 2001
From: Asami Doi <asamidoi@chromium.org>
Date: Wed, 9 Jun 2021 16:42:08 +0000
Subject: [PATCH] Call OnJavascriptDisallowed in the dtor of
 ServiceWorkerInternalsHandler

OnJavascriptDisallowed() should be called to remove observers from the
observer list when a page is destructed but it may not be called when
1) TabStripModel::ShouldRunUnloadListenerBeforeClosing() returns true
   and FastShutdownIfPossible() is not called.
2) FastShutdownIfPossible() returns early and OnJavascriptDisallowed.

To avoid the above cases, this CL calls OnJavascriptDisallowed()
in the destructor of ServiceWorkerInternalsHandler.

(cherry picked from commit a050bc371d8b7937d27620a6ddcbe6a61ae157e5)

Bug: 1199198
Change-Id: I2bd8836c292acbbb00cca0789d8fd5c63d29de86
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2887386
Commit-Queue: Asami Doi <asamidoi@chromium.org>
Reviewed-by: Matt Falkenhagen <falken@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#882847}
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2945177
Commit-Queue: Artem Sumaneev <asumaneev@google.com>
Owners-Override: Artem Sumaneev <asumaneev@google.com>
Reviewed-by: Victor-Gabriel Savu <vsavu@google.com>
Cr-Commit-Position: refs/branch-heads/4430@{#1506}
Cr-Branched-From: e5ce7dc4f7518237b3d9bb93cccca35d25216cbe-refs/heads/master@{#857950}
---
 .../browser/service_worker/service_worker_internals_ui.cc  | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/content/browser/service_worker/service_worker_internals_ui.cc b/content/browser/service_worker/service_worker_internals_ui.cc
index 3d9890244..28d406c7c 100644
--- a/content/browser/service_worker/service_worker_internals_ui.cc
+++ b/content/browser/service_worker/service_worker_internals_ui.cc
@@ -427,7 +427,12 @@ void ServiceWorkerInternalsHandler::OnJavascriptDisallowed() {
   weak_ptr_factory_.InvalidateWeakPtrs();
 }
 
-ServiceWorkerInternalsHandler::~ServiceWorkerInternalsHandler() = default;
+ServiceWorkerInternalsHandler::~ServiceWorkerInternalsHandler() {
+  // ServiceWorkerInternalsHandler can be destroyed without
+  // OnJavascriptDisallowed() ever being called (https://crbug.com/1199198).
+  // Call it to ensure that `this` is removed as an observer.
+  OnJavascriptDisallowed();
+}
 
 void ServiceWorkerInternalsHandler::OnRunningStateChanged() {
   FireWebUIListener("running-state-changed");
-- 
2.20.1

