From ec981dbb2cce5c3d4ee8aba11b9fca4f200e33f9 Mon Sep 17 00:00:00 2001
From: junsungc <junsungc@gooroom.kr>
Date: Fri, 5 Mar 2021 09:48:26 +0900
Subject: [PATCH 29/63] Web socket-worker IPC Bug fix

---
 .../browser/chrome_content_browser_client.cc  |  2 --
 .../settings/privacy_page/privacy_page.html   | 14 +++++++++++++
 chrome/browser/ui/prefs/prefs_tab_helper.cc   |  4 ++--
 gooroom/content/gooroom_safety_policy_part.cc |  4 ++--
 .../common/web_preferences/web_preferences.cc |  4 ++--
 .../common/web_preferences/web_preferences.h  |  4 ++--
 .../web_preferences_mojom_traits.h            |  4 ++--
 .../webpreferences/web_preferences.mojom      |  4 ++--
 .../renderer/core/exported/web_view_impl.cc   | 21 ++++++++++++++++---
 9 files changed, 44 insertions(+), 17 deletions(-)

diff --git a/chrome/browser/chrome_content_browser_client.cc b/chrome/browser/chrome_content_browser_client.cc
index 561e6efe7b1e6..2e60ca232adfe 100644
--- a/chrome/browser/chrome_content_browser_client.cc
+++ b/chrome/browser/chrome_content_browser_client.cc
@@ -3332,8 +3332,6 @@ void ChromeContentBrowserClient::OverrideWebkitPrefs(
       prefs->GetInteger(prefs::kWebKitMinimumLogicalFontSize);
 #endif
 
-  web_prefs->websocket_enabled = true;
-  web_prefs->webworker_enabled = true;
   web_prefs->default_encoding = prefs->GetString(prefs::kDefaultCharset);
 
   web_prefs->dom_paste_enabled =
diff --git a/chrome/browser/resources/settings/privacy_page/privacy_page.html b/chrome/browser/resources/settings/privacy_page/privacy_page.html
index c543fe3aadb90..b7e5bc026e84e 100644
--- a/chrome/browser/resources/settings/privacy_page/privacy_page.html
+++ b/chrome/browser/resources/settings/privacy_page/privacy_page.html
@@ -93,6 +93,20 @@
         <a id="privacySandboxLink" href="privacySandbox"
             target="_blank" tabindex="-1" aria-disabled="true"
             role="none"></a>
+                        <!-- gooroom-browser -->
+                       <div hidden="[[!pageVisibility.websocketSettings]]">
+                         <settings-toggle-button
+                                pref="{{prefs.gooroom_option.websocket_confirm}}"
+                                 label="$i18n{websocketEnable}">
+                         </settings-toggle-button>
+                       </div>
+                       <div hidden="[[!pageVisibility.webworkerSettings]]">
+                        <settings-toggle-button
+                                 pref="{{prefs.gooroom_option.webworker_confirm}}"
+                                 label="$i18n{webworkerEnable}">
+                         </settings-toggle-button>
+                       </div>
+
       </div>
 
 <if expr="use_nss_certs">
diff --git a/chrome/browser/ui/prefs/prefs_tab_helper.cc b/chrome/browser/ui/prefs/prefs_tab_helper.cc
index c60bd9beaef84..f4482bc0cb7c5 100644
--- a/chrome/browser/ui/prefs/prefs_tab_helper.cc
+++ b/chrome/browser/ui/prefs/prefs_tab_helper.cc
@@ -333,9 +333,9 @@ void PrefsTabHelper::RegisterProfilePrefs(
     user_prefs::PrefRegistrySyncable* registry,
     const std::string& locale) {
   WebPreferences pref_defaults;
-  registry->RegisterBooleanPref(prefs::kWebKitWebSocketEnabled,
+  registry->RegisterIntegerPref(prefs::kWebKitWebSocketEnabled,
                                 pref_defaults.websocket_enabled);
-  registry->RegisterBooleanPref(prefs::kWebKitWebWorkerEnabled,
+  registry->RegisterIntegerPref(prefs::kWebKitWebWorkerEnabled,
                                 pref_defaults.webworker_enabled);
   registry->RegisterBooleanPref(prefs::kWebKitJavascriptEnabled,
                                 pref_defaults.javascript_enabled);
diff --git a/gooroom/content/gooroom_safety_policy_part.cc b/gooroom/content/gooroom_safety_policy_part.cc
index 86b07d5838794..a391de1187d39 100644
--- a/gooroom/content/gooroom_safety_policy_part.cc
+++ b/gooroom/content/gooroom_safety_policy_part.cc
@@ -22,14 +22,14 @@ void GooroomSafetyPolicyPart::OverrideWebkitPrefs(
     bool confirm = ps->GetBoolean("gooroom_option.websocket_confirm");
     web_prefs->websocket_enabled = confirm ? 1 : 2;
   } else {
-    web_prefs->websocket_enabled = false;
+    web_prefs->websocket_enabled = 0;
   }
 
   if (gooroom::g_gooroom->useWebWorker()) {
     bool confirm = ps->GetBoolean("gooroom_option.webworker_confirm");
     web_prefs->webworker_enabled = confirm ? 1 : 2;
   } else {
-    web_prefs->webworker_enabled = false;
+    web_prefs->webworker_enabled = 0;
   }
 
   return;
diff --git a/third_party/blink/common/web_preferences/web_preferences.cc b/third_party/blink/common/web_preferences/web_preferences.cc
index ae5aeffcca18d..9c47adf045c19 100644
--- a/third_party/blink/common/web_preferences/web_preferences.cc
+++ b/third_party/blink/common/web_preferences/web_preferences.cc
@@ -39,13 +39,13 @@ WebPreferences::WebPreferences()
       minimum_font_size(0),
       minimum_logical_font_size(6),
       default_encoding("ISO-8859-1"),
+      websocket_enabled(1),
+      webworker_enabled(1),
 #if defined(OS_WIN)
       context_menu_on_mouse_up(true),
 #else
       context_menu_on_mouse_up(false),
 #endif
-      websocket_enabled(true),
-      webworker_enabled(true),
       javascript_enabled(true),
       web_security_enabled(true),
       loads_images_automatically(true),
diff --git a/third_party/blink/public/common/web_preferences/web_preferences.h b/third_party/blink/public/common/web_preferences/web_preferences.h
index b91c77e879cf5..ba163dff6443a 100644
--- a/third_party/blink/public/common/web_preferences/web_preferences.h
+++ b/third_party/blink/public/common/web_preferences/web_preferences.h
@@ -54,8 +54,8 @@ struct BLINK_COMMON_EXPORT WebPreferences {
   int minimum_font_size;
   int minimum_logical_font_size;
   std::string default_encoding;
-  bool websocket_enabled;
-  bool webworker_enabled;
+  int websocket_enabled;
+  int webworker_enabled;
   bool context_menu_on_mouse_up;
   bool javascript_enabled;
   bool web_security_enabled;
diff --git a/third_party/blink/public/common/web_preferences/web_preferences_mojom_traits.h b/third_party/blink/public/common/web_preferences/web_preferences_mojom_traits.h
index 7746c4e051487..7a9a96bbbf38e 100644
--- a/third_party/blink/public/common/web_preferences/web_preferences_mojom_traits.h
+++ b/third_party/blink/public/common/web_preferences/web_preferences_mojom_traits.h
@@ -70,12 +70,12 @@ struct BLINK_COMMON_EXPORT StructTraits<blink::mojom::WebPreferencesDataView,
     return r.default_encoding;
   }
 
-  static bool webworker_enabled(
+  static uint32_t webworker_enabled(
       const blink::web_pref::WebPreferences& r) {
     return r.webworker_enabled;
   }
 
-  static bool websocket_enabled(
+  static uint32_t websocket_enabled(
       const blink::web_pref::WebPreferences& r) {
     return r.websocket_enabled;
   }
diff --git a/third_party/blink/public/mojom/webpreferences/web_preferences.mojom b/third_party/blink/public/mojom/webpreferences/web_preferences.mojom
index dfb81cd9f6dc0..34b14abf37083 100644
--- a/third_party/blink/public/mojom/webpreferences/web_preferences.mojom
+++ b/third_party/blink/public/mojom/webpreferences/web_preferences.mojom
@@ -110,8 +110,8 @@ struct WebPreferences {
   int32 minimum_font_size;
   int32 minimum_logical_font_size;
   string default_encoding;
-  bool websocket_enabled;
-  bool webworker_enabled;
+  int32 websocket_enabled;
+  int32 webworker_enabled;
   bool context_menu_on_mouse_up;
   bool javascript_enabled;
   bool web_security_enabled;
diff --git a/third_party/blink/renderer/core/exported/web_view_impl.cc b/third_party/blink/renderer/core/exported/web_view_impl.cc
index 4b5620cb7cf79..52eeb3424c709 100644
--- a/third_party/blink/renderer/core/exported/web_view_impl.cc
+++ b/third_party/blink/renderer/core/exported/web_view_impl.cc
@@ -1433,9 +1433,6 @@ void WebView::ApplyWebPreferences(const web_pref::WebPreferences& prefs,
   settings->SetDefaultTextEncodingName(
       WebString::FromASCII(prefs.default_encoding));
   settings->SetJavaScriptEnabled(prefs.javascript_enabled);
-  settings->SetJavaScriptEnabled(prefs.websocket_enabled);
-  settings->SetJavaScriptEnabled(prefs.webworker_enabled);
-  settings->SetJavaScriptEnabled(prefs.javascript_enabled);
   settings->SetWebSecurityEnabled(prefs.web_security_enabled);
   settings->SetLoadsImagesAutomatically(prefs.loads_images_automatically);
   settings->SetImagesEnabled(prefs.images_enabled);
@@ -1447,6 +1444,24 @@ void WebView::ApplyWebPreferences(const web_pref::WebPreferences& prefs,
   settings->SetJavaScriptCanAccessClipboard(
       prefs.javascript_can_access_clipboard);
   RuntimeEnabledFeatures::SetXSLTEnabled(prefs.xslt_enabled);
+#if defined(GOOROOM_BUILD)
+  if (prefs.websocket_enabled) {
+    WebRuntimeFeatures::EnableWebSocket(true);
+    WebRuntimeFeatures::EnableWebSocketConfirm(prefs.websocket_enabled == 1);
+  } else {
+    WebRuntimeFeatures::EnableWebSocket(false);
+    WebRuntimeFeatures::EnableWebSocketConfirm(false);
+  }
+
+  if (prefs.webworker_enabled) {
+    WebRuntimeFeatures::EnableWebWorker(true);
+    WebRuntimeFeatures::EnableWebWorkerConfirm(prefs.webworker_enabled == 1);
+  } else {
+    WebRuntimeFeatures::EnableWebWorker(false);
+    WebRuntimeFeatures::EnableWebWorkerConfirm(false);
+  }
+#endif
+  RuntimeEnabledFeatures::SetXSLTEnabled(prefs.xslt_enabled);
   settings->SetDNSPrefetchingEnabled(prefs.dns_prefetching_enabled);
   blink::WebNetworkStateNotifier::SetSaveDataEnabled(prefs.data_saver_enabled);
   settings->SetLocalStorageEnabled(prefs.local_storage_enabled);
-- 
2.30.2

